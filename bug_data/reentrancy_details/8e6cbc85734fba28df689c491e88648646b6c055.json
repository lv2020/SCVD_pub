{"filename": "contracts/protocol/libraries/logic/SupplyLogic.sol", "patch": "@@ -128,14 +128,22 @@ library SupplyLogic {\n \n     reserve.updateInterestRates(reserveCache, params.asset, 0, amountToWithdraw);\n \n+    bool isCollateral;\n+\n+    if ((isCollateral = userConfig.isUsingAsCollateral(reserve.id))) {\n+      if (amountToWithdraw == userBalance) {\n+        userConfig.setUsingAsCollateral(reserve.id, false);\n+        emit ReserveUsedAsCollateralDisabled(params.asset, msg.sender);\n+      }\n+    }\n     IAToken(reserveCache.aTokenAddress).burn(\n       msg.sender,\n       params.to,\n       amountToWithdraw,\n       reserveCache.nextLiquidityIndex\n     );\n \n-    if (userConfig.isUsingAsCollateral(reserve.id)) {\n+    if (isCollateral) {\n       if (userConfig.isBorrowingAny()) {\n         ValidationLogic.validateHFAndLtv(\n           reservesData,\n@@ -149,11 +157,6 @@ library SupplyLogic {\n           params.userEModeCategory\n         );\n       }\n-\n-      if (amountToWithdraw == userBalance) {\n-        userConfig.setUsingAsCollateral(reserve.id, false);\n-        emit ReserveUsedAsCollateralDisabled(params.asset, msg.sender);\n-      }\n     }\n \n     emit Withdraw(params.asset, msg.sender, params.to, amountToWithdraw);\n@@ -264,7 +267,12 @@ library SupplyLogic {\n \n     if (useAsCollateral) {\n       require(\n-        ValidationLogic.validateUseAsCollateral(reservesData, reservesList, userConfig, reserveCache.reserveConfiguration),\n+        ValidationLogic.validateUseAsCollateral(\n+          reservesData,\n+          reservesList,\n+          userConfig,\n+          reserveCache.reserveConfiguration\n+        ),\n         Errors.USER_IN_ISOLATION_MODE\n       );\n ", "project_link": "https://github.com/aave/aave-v3-core/commit/8e6cbc85734fba28df689c491e88648646b6c055", "bug_version": {"raw_code": "", "flattened_code": "", "commit_id": "9916947949d3a50762fc8b15a6632423723d0bc3"}, "fixed_version": {"raw_code": "", "flattened_code": "", "commit_id": "8e6cbc85734fba28df689c491e88648646b6c055"}}